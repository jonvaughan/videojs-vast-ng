/*!
 * videojs-vast-ng - A VAST plugin for VideoJS
 * v0.1.0
 * https://github.com/pragmaticlabs/videojs-vast-ng
 * copyright  2015
 * MIT License
*/
!function(a,b,c){"use strict";var d;d=a.DOMParser?function(b){return(new a.DOMParser).parseFromString(b,"text/xml")}:"undefined"!=typeof a.ActiveXObject&&new a.ActiveXObject("Microsoft.XMLDOM")?function(b){var c=new a.ActiveXObject("Microsoft.XMLDOM");return c.async="false",c.loadXML(b),c}:function(){return null}}(window,videojs,CrossXHR),function(a,b,c,d,e){"use strict";function f(d){var f,g,i,j,k,l,m=this,n=m.el();m.vast=m.vast||{};var o=function(c){var f,g,h,i,j,k,l={},n=m.options().techOrder;for(f=0;f<n.length;f++)if(h=n[f],i=h.charAt(0).toUpperCase()+h.slice(1),j=a.videojs[i],k=l[h]=[],j)if(j.isSupported())for(g=0;g<c.length;g++){var o=c[g],p={type:o.mimeType,src:o.fileURL,width:o.width,height:o.height,apiFramework:o.apiFramework,adParameters:o.adParameters,duration:o.duration,bitrate:o.bitrate};j.canPlaySource(p)&&k.push(p)}else b.log.warn("vast","createSourceObjects",'skipping "'+i+'"; tech not supported');else b.log.warn("vast","createSourceObjects",'skipping "'+i+'"; tech not found');var q=[];for(f=0;f<n.length;f++)if(j=n[f],l[j]!==e)for(g=0;g<l[j].length;g++)q.push(l[j][g]);else d.debug&&b.log("vast","createSourceObjects","no sources found for tech:",j);return q},p=function(a){if(!a)return!1;for(var b=0;b<a.length;b++)if("VPAID"===a[b].apiFramework)return!0;return!1},q=function(){var a=!1,e=j,f=function(){d.debug&&b.log("vast","event","canplay"),j.load()},g=function(){isNaN(e.assetDuration)&&(e.assetDuration=m.duration()),e.setProgress(m.currentTime())},h=function(){d.debug&&b.log("vast","event","pause"),e.setPaused(!0),m.one("play",function(){d.debug&&b.log("vast","event","pauseFn","play"),e.setPaused(!1)})},i=function(d){b.log.error("vast","event","error",d),c.util.track(e.ad.errorURLTemplates,{ERRORCODE:405}),a=!0,m.trigger("ended")};m.on("canplay",f),m.on("timeupdate",g),m.on("pause",h),m.on("error",i),m.one("adend",function(){m.off("canplay",f),m.off("timeupdate",g),m.off("pause",h),m.off("error",i),a||e.complete()})},r=function(){d.debug&&b.log("vast","clicked");var e;if(j.clickThroughURLTemplate&&(e=c.util.resolveURLTemplates([j.clickThroughURLTemplate],{CACHEBUSTER:Math.round(1e10*Math.random()),CONTENTPLAYHEAD:j.progressFormated()})[0]),e){if(m.paused())return m.play(),!1;j.clickTrackingURLTemplate&&j.trackURLs([j.clickTrackingURLTemplate]),m.trigger("adclick"),a.open(e,"_blank"),m.pause()}},s=function(){return d.skip<0?void(d.debug&&b.log("vast","init ui","skip < 0, disabling skip button")):(l&&(b.log.warn("vast","init ui","skip button already exists. removing it first"),t()),l=b.Component.prototype.createEl("div",{className:"vast-skip-button",onclick:function(b){return(" "+l.className+" ").indexOf(" enabled ")>=0&&(j.skip(),y()),a.Event.prototype.stopPropagation===e?!1:void b.stopPropagation()}}),b.insertFirst(l,n),void m.on("timeupdate",u))},t=function(){return l&&l.parentNode?(l.parentNode.removeChild(l),l=null,void m.off("timeupdate",u)):void(d.debug&&b.log("vast","remove","no skip button found:",l))},u=function(){if(!l)return void t();var a=Math.ceil(d.skip-m.currentTime());a>0?l.innerHTML="AD#"+k.count+"/"+d.maxAdCount+" Skip in "+a+"...":-1===(" "+l.className+" ").indexOf(" enabled ")&&(l.className+=" enabled",l.innerHTML="AD#"+k.count+"/"+d.maxAdCount+" Skip")},v=function(){for(var a=0;a<i.variations.length;a++){var c=i.variations[a],e="#"+m.id()+"-"+c.width+"x"+c.height,f=document.querySelector(e);if(f)if(c.staticResource){var g=new Image;g.src=c.staticResource,g.width=c.width,g.height=c.height;var h=document.createElement("a");h.setAttribute("target","_blank"),h.href=c.companionClickThroughURLTemplate,h.appendChild(g),f.innerHTML="",f.appendChild(h)}else if(c.htmlResource)f.innerHTML=c.htmlResource;else if(c.iframeResource){var j=b.Component.prototype.createEl("iframe",{scrolling:"no",marginWidth:0,marginHeight:0,frameBorder:0,src:c.iframeResource});f.appendChild(j)}else d.debug&&b.log("vast","ignoring companion: ",c);else d.debug&&b.log("no companion element found:",e)}},w=function(){d.debug&&b.log("vast","startLinearAdBreak"),m.ads.startLinearAdMode(),f=m.controls(),f&&m.controls(!1)},x=function(){d.debug&&b.log("vast","endLinearAdBreak"),f&&(d.debug&&b.log("vast","unloadAd","enable controls"),m.controls(!0)),m.ads.endLinearAdMode(),k=null,m.play()},y=function(a){return d.debug&&b.log("vast","endAd",m.ads.state),m.off("ended",y),k?(b.log("adbreak",k),m.off("click",r),t(),void(a===!0||k.attempts>=d.maxAdAttempts||k.count>=d.maxAdCount?x():A())):void b.log.warn("vast","endAd","not playing an AD! state: "+m.ads.state)},z=function(){d.debug&&b.log("vast","startAd",m.ads.state),"ad-playback"!==m.ads.state&&w(),k.count++,"Vpaidflash"===m.techName&&m.ended()&&(m.techName=null),m.src(g),j&&!p(g)&&(m.on("click",r),s()),i&&v(),q(),m.on("ended",y),m.play()},A=function(){return d.debug&&b.log("vast","loadVAST"),k.attempts++,d.url?void c.client.get(d.url,{urlhandler:d.customURLHandler},function(a){if(d.debug&&b.log("vast","loadVAST","response",a),a)for(var f=0;f<a.ads.length;f++){for(var h=a.ads[f],k=!1,l=!1,n=0;n<h.creatives.length&&(!k||!l);n++){var p=h.creatives[n];switch(p.type){case"linear":if(k){b.log.warn("vast","loadVAST","ignoring linear; already found one");continue}if(!p.mediaFiles.length){b.log.warn("vast","loadVAST","ignoring linear; no media files found");continue}var q=o(p.mediaFiles);q&&q.length&&(g=q,k=!0,j=new c.tracker(h,p));break;case"companion":if(l){b.log.warn("vast","loadVAST","ignoring companion; already found one");continue}i=p,l=!0;break;default:b.log.warn("vast","loadVAST","unknown creative found:",p)}}if(k)return d.debug&&b.log("vast","loadVAST","found VAST"),void z();g=e,i=e,c.util.track(h.errorURLTemplates,{ERRORCODE:403})}m.trigger("adscanceled")}):void m.trigger("adscanceled")},B=function(){d.debug&&b.log("vast","unloadAd"),y(),g=null,i=null,j=null};return m.vast.preroll=function(){k={attempts:0,count:0},A()},m.vast.midroll=function(){throw new Error("midroll not implemented")},m.vast.postroll=function(){throw new Error("postroll not implemented")},m.vast.ensureLeaveAdBreak=function(){y(!0),B()},m.vast.tracker=function(){return j},m.vast.skip=function(a){return a===e?d.skip:void(d.skip=a)},m.vast.url=function(a){return a===e?d.url:void(d.url=a)},m.vast.maxAdCount=function(a){return a===e?d.maxAdCount:void(d.maxAdCount=a)},m.vast.maxAdAttempts=function(a){return a===e?d.maxAdAttempts:void(d.maxAdAttempts=a)},m.vast.currentAdAttempt=function(){return k?k.attempts:e},m.vast.currentAdCount=function(){return k?k.count:e},m.ads===e?(b.log.error("vast","vast video plugin requires videojs-contrib-ads, vast plugin not initialized"),null):(m.on("contentupdate",function(a){d.debug&&b.log("vast","contentupdate",a.newValue),m.trigger("adsready")}),m.on("readyforpreroll",function(){d.debug&&b.log("vast","readyforpreroll"),m.vast.preroll()}),void(d=b.util.mergeOptions({debug:!1,skip:5,customURLHandler:h,maxAdAttempts:1,maxAdCount:1,adParameters:{}},d)))}var g;g=a.DOMParser?function(b){return(new a.DOMParser).parseFromString(b,"text/xml")}:"undefined"!=typeof a.ActiveXObject&&new a.ActiveXObject("Microsoft.XMLDOM")?function(b){var c=new a.ActiveXObject("Microsoft.XMLDOM");return c.async="false",c.loadXML(b),c}:function(){return null};var h={supported:function(){return d&&b.Flash.isSupported()},get:function(a,c,e){try{var f=new d;f.onreadystatechange=function(){if(4===f.readyState){var a=g(f.responseText);c.debug&&b.log("vast","vast response",a),e(null,a)}},c.debug&&b.log("request to ",a),f.open("GET",a),f.send()}catch(h){b.log.warn(h),e()}}};b.plugin("vast",f)}(window,videojs,DMVAST,CrossXHR),vjs.Vpaidflash=vjs.MediaTechController.extend({init:function(a,b,c){vjs.MediaTechController.call(this,a,b,c);var d=b.source,e=a.id()+"_vpaidflash_api",f=a.options_,g=vjs.obj.merge({readyFunction:"vjs.Vpaidflash.onReady",eventProxyFunction:"vjs.Vpaidflash.onEvent",errorEventProxyFunction:"vjs.Vpaidflash.onError",autoplay:f.autoplay,preload:f.preload,loop:f.loop,muted:f.muted},b.flashVars),h=vjs.obj.merge({wmode:"opaque",bgcolor:"#000000"},b.params),i=vjs.obj.merge({id:e,name:e,"class":"vjs-tech"},b.attributes);d&&this.ready(function(){this.setSource(d)}),vjs.insertFirst(this.el_,b.parentEl),b.startTime&&this.ready(function(){this.load(),this.play(),this.currentTime(b.startTime)}),vjs.IS_FIREFOX&&this.ready(function(){this.on("mousemove",function(){this.player().trigger({type:"mousemove",bubbles:!1})})}),a.on("stageclick",a.reportUserActivity),this.el_=vjs.Flash.embed(b.swf,this.el_,g,h,i)}}),vjs.Vpaidflash.prototype.dispose=function(){vjs.MediaTechController.prototype.dispose.call(this)},vjs.Vpaidflash.prototype.play=function(){this.el_.vjs_play()},vjs.Vpaidflash.prototype.pause=function(){this.el_.vjs_pause()},vjs.Vpaidflash.prototype.src=function(a){return void 0===a?this.currentSrc():this.setSrc(a)},vjs.Vpaidflash.prototype.setSrc=function(a){if(this.player_.vast&&this.player_.vast.sources){var b,c=this.player_.vast.sources();vjs.arr.forEach(c,function(c){c.src===a&&(b=c)},this),b&&(this.el_.vjs_setProperty("adParameters",b.adParameters),this.el_.vjs_setProperty("duration",b.duration),this.el_.vjs_setProperty("bitrate",b.bitrate),this.el_.vjs_setProperty("width",b.width),this.el_.vjs_setProperty("height",b.height),this.player_.duration(b.duration),this.trackCurrentTime())}if(a=vjs.getAbsoluteURL(a),this.el_.vjs_src(a),this.player_.autoplay()){var d=this;this.setTimeout(function(){d.play()},0)}},vjs.Vpaidflash.prototype.setCurrentTime=function(a){this.lastSeekTarget_=a,this.el_.vjs_setProperty("currentTime",a),vjs.MediaTechController.prototype.setCurrentTime.call(this)},vjs.Vpaidflash.prototype.currentTime=function(){return this.seeking()?this.lastSeekTarget_||0:this.el_.vjs_getProperty("currentTime")},vjs.Vpaidflash.prototype.currentSrc=function(){return this.currentSource_?this.currentSource_.src:this.el_.vjs_getProperty("currentSrc")},vjs.Vpaidflash.prototype.load=function(){this.el_.vjs_load()},vjs.Vpaidflash.prototype.poster=function(){this.el_.vjs_getProperty("poster")},vjs.Vpaidflash.prototype.setPoster=function(){},vjs.Vpaidflash.prototype.buffered=function(){return vjs.createTimeRange(0,this.el_.vjs_getProperty("buffered"))},vjs.Vpaidflash.prototype.supportsFullScreen=function(){return!1},vjs.Vpaidflash.prototype.enterFullScreen=function(){return!1},function(){function a(a){var b=a.charAt(0).toUpperCase()+a.slice(1);d["set"+b]=function(b){return this.el_.vjs_setProperty(a,b)}}function b(a){d[a]=function(){return this.el_.vjs_getProperty(a)}}var c,d=vjs.Vpaidflash.prototype,e="preload,defaultPlaybackRate,playbackRate,autoplay,loop,mediaGroup,controller,controls,volume,muted,defaultMuted".split(","),f="error,networkState,readyState,seeking,initialTime,duration,startOffsetTime,paused,played,seekable,ended,videoTracks,audioTracks,width,height".split(",");for(c=0;c<e.length;c++)b(e[c]),a(e[c]);for(c=0;c<f.length;c++)b(f[c])}(),vjs.Vpaidflash.isSupported=function(){return vjs.Vpaidflash.version()[0]>=10},vjs.MediaTechController.withSourceHandlers(vjs.Vpaidflash),vjs.Vpaidflash.nativeSourceHandler={},vjs.Vpaidflash.nativeSourceHandler.canHandleSource=function(a){var b;return a.type?(b=a.type.replace(/;.*/,"").toLowerCase(),b in vjs.Vpaidflash.formats?"maybe":""):""},vjs.Vpaidflash.nativeSourceHandler.handleSource=function(a,b){b.setSrc(a.src)},vjs.Vpaidflash.nativeSourceHandler.dispose=function(){},vjs.Vpaidflash.registerSourceHandler(vjs.Vpaidflash.nativeSourceHandler),vjs.Vpaidflash.formats={"application/x-shockwave-flash":"SWF"},vjs.Vpaidflash.onReady=function(a){var b,c;b=vjs.el(a),c=b&&b.parentNode&&b.parentNode.player,c&&(b.player=c,vjs.Vpaidflash.checkReady(c.tech))},vjs.Vpaidflash.checkReady=function(a){a.el()&&(a.el().vjs_getProperty?a.triggerReady():this.setTimeout(function(){vjs.Vpaidflash.checkReady(a)},50))},vjs.Vpaidflash.onEvent=function(a,b){var c=vjs.el(a).player;c.trigger(b)},vjs.Vpaidflash.onError=function(a,b){var c=vjs.el(a).player,d="FLASH: "+b;c.error("srcnotfound"==b?{code:4,message:d}:d)},vjs.Vpaidflash.version=function(){var a="0,0,0";try{a=new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(b){try{navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(a=(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1])}catch(c){}}return a.split(",")},vjs.Vpaidflash.embed=function(a,b,c,d,e){var f=vjs.Vpaidflash.getEmbedCode(a,c,d,e),g=vjs.createEl("div",{innerHTML:f}).childNodes[0],h=b.parentNode;b.parentNode.replaceChild(g,b),g[vjs.expando]=b[vjs.expando];var i=h.childNodes[0];return setTimeout(function(){i.style.display="block"},1e3),g},vjs.Vpaidflash.getEmbedCode=function(a,b,c,d){var e='<object type="application/x-shockwave-flash" ',f="",g="",h="";return b&&vjs.obj.each(b,function(a,b){f+=a+"="+b+"&amp;"}),c=vjs.obj.merge({movie:a,flashvars:f,allowScriptAccess:"always",allowNetworking:"all"},c),vjs.obj.each(c,function(a,b){g+='<param name="'+a+'" value="'+b+'" />'}),d=vjs.obj.merge({data:a,width:"100%",height:"100%"},d),vjs.obj.each(d,function(a,b){h+=a+'="'+b+'" '}),e+h+">"+g+"</object>"},function(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l,m=function(){if(h.getAdDuration){var a=h.getAdDuration();a>0&&k.setDuration(a)}},n=function(){f.trigger("ended")},o=function(){k=f.vast.tracker(),h.startAd(),m(),f.trigger("ads-ready")},p=function(){f.removeClass("vjs-vpaidjs-started"),k=null,f.trigger("ended"),f&&f.techName&&(f.techName=null,f.unloadTech())},q=function(){m()},r=function(){m()},s=function(){k.skip(),f.trigger("ended")},t=function(){k.load(),f.addClass("vjs-vpaidjs-started")},u=function(){k.setMuted(0===h.getAdVolume()),f.setVolume(h.getAdVolume())},v=function(){},w=function(){k.setProgress(0),f.paused()||f.pause()},x=function(){var a=Math.round(25*h.getAdDuration())/100;k.setProgress(a)},y=function(){var a=Math.round(50*h.getAdDuration())/100;k.setProgress(a)},z=function(){var a=Math.round(75*h.getAdDuration())/100;k.setProgress(a)},A=function(){k.setProgress(h.getAdDuration())},B=function(){k.click()},C=function(){k.acceptInvitation()},D=function(){k.close()},E=function(){k.setPaused(!0),f.paused()||f.pause()},F=function(){k.setPaused(!1),f.paused()&&f.play()},G=function(){h.getAdSkippableState()||l&&l.parentNode.removeChild(l)},H=function(){h.subscribe(n,"AdError"),h.subscribe(o,"AdLoaded"),h.subscribe(p,"AdStopped"),h.subscribe(q,"AdDurationChange"),h.subscribe(r,"AdRemainingTimeChange"),h.subscribe(s,"AdSkipped"),h.subscribe(t,"AdStarted"),h.subscribe(u,"AdVolumeChange"),h.subscribe(v,"AdImpression"),h.subscribe(w,"AdVideoStart"),h.subscribe(x,"AdVideoFirstQuartile"),h.subscribe(y,"AdVideoMidpoint"),h.subscribe(z,"AdVideoThirdQuartile"),h.subscribe(A,"AdVideoComplete"),h.subscribe(B,"AdClickThru"),h.subscribe(C,"AdUserAcceptInvitation"),h.subscribe(D,"AdUserClose"),h.subscribe(E,"AdPaused"),h.subscribe(F,"AdPlaying"),h.subscribe(G,"AdSkippableStateChange")},I=function(){h.unsubscribe(n,"AdError"),h.unsubscribe(o,"AdLoaded"),h.unsubscribe(p,"AdStopped"),h.unsubscribe(q,"AdDurationChange"),h.unsubscribe(r,"AdRemainingTimeChange"),h.unsubscribe(s,"AdSkipped"),h.unsubscribe(t,"AdStarted"),h.unsubscribe(u,"AdVolumeChange"),h.unsubscribe(v,"AdImpression"),h.unsubscribe(w,"AdVideoStart"),h.unsubscribe(x,"AdVideoFirstQuartile"),h.unsubscribe(y,"AdVideoMidpoint"),h.unsubscribe(z,"AdVideoThirdQuartile"),h.unsubscribe(A,"AdVideoComplete"),h.unsubscribe(B,"AdClickThru"),h.unsubscribe(C,"AdUserAcceptInvitation"),h.unsubscribe(D,"AdUserClose"),h.unsubscribe(E,"AdPaused"),h.unsubscribe(F,"AdPlaying"),h.unsubscribe(G,"AdSkippableStateChange")},J=function(){i=c.Component.prototype.createEl("iframe",{scrolling:"no",marginWidth:0,marginHeight:0,frameBorder:0,webkitAllowFullScreen:"true",mozallowfullscreen:"true",allowFullScreen:"true"}),i.onload=function(){var a=i.contentDocument,b=a.getElementsByTagName("head")[0],d=a.createElement("script");d.type="text/javascript",d.src=f.currentSrc(),d.addEventListener?d.addEventListener("load",function(){N()}):d.readyState?d.onreadystatechange=function(){N()}:c.log.warn("no event listener function available"),b.appendChild(d)},b.body.appendChild(i)},K=function(){return O(),i?(b.body.removeChild(i),void(i=null)):void c.log.warn("no VPAID container defined")},L=function(){/iphone|ipad|android/gi.test(navigator.userAgent)&&(j=g.querySelector("video.vjs-tech")),j||(j=c.Component.prototype.createEl("video",{id:f.id()+"_vpaidjs_api",scrolling:"no",marginWidth:0,marginHeight:0,frameBorder:0,webkitAllowFullScreen:"true",mozallowfullscreen:"true",allowFullScreen:"true"}),c.insertFirst(j,g))},M=function(){return j?void(j.id===f.id()+"_vpaidjs_api"&&(g.removeChild(j),j=null)):void c.log.warn("no VPAID tech defined")},N=function(){if(!i)return void c.log.error("Vpaidjs","_initVPAID","no VPAID iframe available");if(i.contentWindow.getVPAIDAd!==d){if(h=i.contentWindow.getVPAIDAd(),"2.0"!==h.handshakeVersion("2.0"))throw new Error("Versions different to 2.0 are not supported");L();var a={videoSlotCanAutoPlay:!0,slot:g,videoSlot:j};H(),h.initAd(f.width(),f.height(),e.viewMode,e.bitrate,{},a)}},O=function(){I(),M(),h=null};c.Vpaidjs=c.Html5.extend({init:function(a,b,d){e=c.util.mergeOptions({viewMode:"normal",bitrate:1e3},b),f=a,g=a.el(),J(),b.source&&this.ready(function(){this.src(b.source.src)}),c.MediaTechController.call(this,a,b,d),this.triggerReady()}}),c.Vpaidjs.prototype.dispose=function(){K(),e=null,f=null,g=null,k=null,c.MediaTechController.prototype.dispose.call(this)},c.Vpaidjs.canPlaySource=function(a){return"application/javascript"===a.type?"maybe":""},c.Vpaidjs.isSupported=function(){return!0}}(window,document,videojs);